---
layout: with-nonav
---

<div class="Book">

  {% if page.lang == 'en' %}
  <div class="Book__Title english">
    <h3>Chapter {{page.order}}</h3>
    <h2>{{page.title}}</h2>
  </div>
  {% else %}
  <div class="Book__Title">
    <h3>第{{page.chapter}}章</h3>
    <h2>{{page.title}}</h2>
  </div>
  {% endif %}

  <div>
    {% include bookdetail_meta.html top="1" %}
  </div>

  <div id="Book__Content" class="Book__Content lang-{{page.lang}}">
    {% if page.lang == 'en' %}
    <div class="IhateThisKiddyFont">
      <a href="javascript:IhateThisKiddyFont();" class="pink">
        I hate this <span class="english">kiddy</span> font!
      </a>
    </div>
    {% endif %}
    {{content}}
  </div>

  <div class="Book__End" style="height: 1px; background: #ddd; width: 61.8%; margin: 3rem auto"></div>

  <div>
    {% include bookdetail_meta.html %}
  </div>

  <div class="Book__Side Book__Chapters lang-{{page.lang}}">
    <ul class="">
      {% assign chapters = site[page.book] | where: 'lang', page.lang | sort: 'order' %}
      {% for chapter in chapters %}
      <li>
        <a href="{{chapter.url}}" class="{% if page.path == chapter.path %}disabled{% else %}normal{% endif %}">
          {{chapter.order}}. {{chapter.title}}
        </a>
      </li>
      {% endfor %}
    </ul>
  </div>

  <div class="Book_Top_Bar" style="
      z-index: 40;
      position: fixed;
      width: 100vw;
      height: fit-content;
      left: 0;
      top: 0;
      height: 4px;
      background-color: rgb(30, 40, 49);
  "></div>

  <div class="Book_Read_Progress" style="
      z-index: 40;
      position: fixed;
      width: 100vw;
      height: fit-content;
      left: 0;
      bottom: 0;
      background-color: rgb(30, 40, 49);
    ">
    <div class="IN" style="
        font-size: 0.8rem;
        line-height: 1rem;
        width: 0;
        height: 1rem;
        background-color: #ddd;
        text-align: right;
        color: #222;
      "></div>
  </div>

  <div class="Book__Side Book__Chapter_Menu lang-{{page.lang}}">
    <script>
      let h2h3_highlighted = () => { }

      {
        const bookContent = document.querySelector("#Book__Content")
        const h2h3 = bookContent.querySelectorAll("h2, h3, h4")

        document.writeln("<h4>{% if page.lang == 'en' %}Sections{% else %}目錄{% endif %}</h4>")
        document.writeln("<ul id='Book__Chapter_Menu__List'>")
        h2h3.forEach((el, n) => {
          const text = el.textContent
          const id = el.id || text.replace(/\s+/g, "-").toLowerCase()
          document.writeln(
            `<li class="${el.tagName}"><a data-index="${n}" href="#${id}">${text}</a></li>`,
          )
        })
        document.writeln("</ul>")

        document.addEventListener("DOMContentLoaded", () => {
          const Book__Chapter_Menu__List = document.querySelector(
            "#Book__Chapter_Menu__List",
          )

          Book__Chapter_Menu__List.addEventListener("click", (evt) => {
            if (evt.target.tagName === "A") {
              const n = +evt.target.getAttribute("data-index")
              h2h3_highlighted(n)
            }

            requestAnimationFrame(updateReadProgress)
          })

          const listitems = Book__Chapter_Menu__List.querySelectorAll(
            "#Book__Chapter_Menu__List li",
          )

          h2h3_highlighted = (n) => {
            listitems.forEach((li, i) => {
              if (i === n) {
                li.classList.add("highlighted")
              } else {
                li.classList.remove("highlighted")
              }
            })
          }
        })

        const PageWrapper = document.querySelector(".page-wrapper")
        const BookReadProgressBar = document.querySelector(
          ".Book_Read_Progress .IN",
        )

        function updateReadProgress() {
          const progress =
            PageWrapper.scrollTop /
            (PageWrapper.scrollHeight - window.innerHeight)
          BookReadProgressBar.style.width = `${progress * 100}%`
          BookReadProgressBar.textContent = `${Math.round(progress * 100)}%`
        }

        PageWrapper.addEventListener(
          "wheel", // wheel
          updateReadProgress,
          {
            passive: true,
          },
        )
      }
    </script>
  </div>
</div>

<script>
  {
    class HeadingTracker extends EventTarget {
      #bookContent = document.querySelector("#Book__Content")

      constructor() {
        super()
        this.headings = Array.from(this.#bookContent.querySelectorAll("h2, h3, h4"))
        this.visibleHeadings = new Set()
        this.currentHeading = null
        this._initObserver()
      }

      _initObserver() {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              const heading = entry.target
              if (entry.isIntersecting) {
                this.visibleHeadings.add(heading)
              } else {
                this.visibleHeadings.delete(heading)
              }
            })

            const sorted = Array.from(this.visibleHeadings).sort(
              (a, b) =>
                a.getBoundingClientRect().top - b.getBoundingClientRect().top,
            )

            const topHeading = sorted[0]
            if (topHeading && topHeading !== this.currentHeading) {
              this.currentHeading = topHeading
              this.dispatchEvent(
                new CustomEvent("headingchange", {
                  detail: {
                    index: this.headings.indexOf(topHeading),
                    element: topHeading,
                    tag: topHeading.tagName.toLowerCase(),
                    text: topHeading.textContent.trim(),
                  },
                }),
              )
            }
          },
          {
            rootMargin: "-20% 0px -60% 0px", // 控制觸發範圍
            threshold: 0.1,
          },
        )

        this.headings.forEach((h) => observer.observe(h))
      }
    }

    const tracker = new HeadingTracker()

    tracker.addEventListener("headingchange", (e) => {
      const { tag, text, index } = e.detail
      h2h3_highlighted(index)
    })
  }

  function PlayCourseVideo() {
    const videoUrl = "{{ page.video }}"
    if (videoUrl) {
      window.open(videoUrl, "_blank")
    } else {
      alert("No video available for this course.")
    }
  }

  function IhateThisKiddyFont() {
    const BookContent = document.querySelector('#Book__Content');
    BookContent.classList.add('kiddy-font-disabled');
    document.querySelector('.IhateThisKiddyFont').style.display = 'none';
  }
</script>