---
layout: with-nonav
---

<div class="Book">

  {% if page.lang == 'en' %}
  <div class="Book__Title english">
    <h3>Chapter {{page.order}}</h3>
    <h2>{{page.title}}</h2>
  </div>
  {% else %}
  <div class="Book__Title">
    <h3>第{{page.chapter}}章</h3>
    <h2>{{page.title}}</h2>
  </div>
  {% endif %}

  <div>
    {% include bookdetail_meta.html top="1" %}
  </div>

  <div id="Book__Content" class="Book__Content lang-{{page.lang}}">
    {% if page.lang == 'en' %}
    <div class="IhateThisKiddyFont" style="font-size: .9em;margin: 0 0 0 0;">
      <a href="javascript:IhateThisKiddyFont();" class="pink">
        <svg xmlns="http://www.w3.org/2000/svg" style="pointer-events: none; vertical-align: middle;" width="24"
          height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mood-sad-2">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
          <path d="M14.5 16.05a3.5 3.5 0 0 0 -5 0" />
          <path d="M10 9.25c-.5 1 -2.5 1 -3 0" />
          <path d="M17 9.25c-.5 1 -2.5 1 -3 0" />
        </svg>
        <span>I hate this <span class="english">kiddy</span> font!</span>
      </a>
    </div>
    {% endif %}
    <div style="font-size: .9em; margin: 0 0 2rem 0; " id="FullscreenToggle">
      <a href="javascript:void(0);" onclick="openFullscreen(event)" style="color: green; width: 24px; height: 24px;"
        rel="noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" style="pointer-events: none; vertical-align: middle;" width="24"
          height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-book">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
          <path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
          <path d="M3 6l0 13" />
          <path d="M12 6l0 13" />
          <path d="M21 6l0 13" />
        </svg>
        <span style="pointer-events: none; color: green;">{% if page.lang == 'en' %}enter reading mode (make a better expericence to read.){% else %}沈浸閱讀（讓你更專注於閱讀）{% endif %}</span>
      </a>
      <a href="javascript:void(0);" onclick="closeFullscreen(event)" style="display: none; color: green; width: 24px; height: 24px;"
        rel="noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" style="pointer-events: none; vertical-align: middle;" width="24"
          height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-book-off">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 5.899 -1.096" />
          <path d="M3 6a9 9 0 0 1 2.114 -.884m3.8 -.21c1.07 .17 2.116 .534 3.086 1.094a9 9 0 0 1 9 0" />
          <path d="M3 6v13" />
          <path d="M12 6v2m0 4v7" />
          <path d="M21 6v11" />
          <path d="M3 3l18 18" />
        </svg>
        <span style="pointer-events: none; color: green;">{% if page.lang == 'en' %}exit reading mode{% else %}退出閱讀模式{% endif %}</span>
      </a>
    </div>
    {{content}}
  </div>

  <div class="Book__End" style="height: 1px; background: #ddd; width: 61.8%; margin: 3rem auto"></div>

  <div>
    {% include bookdetail_meta.html %}
  </div>

  <div class="Book__Side Book__Chapters lang-{{page.lang}}">
    <ul class="">
      {% assign chapters = site[page.book] | where: 'lang', page.lang | sort: 'order' %}
      {% for chapter in chapters %}
      <li>
        <a href="{{chapter.url}}" class="{% if page.path == chapter.path %}disabled{% else %}normal{% endif %}">
          {{chapter.order}}. {{chapter.title}}
        </a>
      </li>
      {% endfor %}
    </ul>
  </div>

  <div class="Book_Top_Bar" style="
      z-index: 40;
      position: fixed;
      width: 100vw;
      left: 0;
      top: 0;
      height: 1rem;
  "></div>

  <div class="Book_Read_Progress" style="
      z-index: 40;
      position: fixed;
      width: 100vw;
      height: fit-content;
      left: 0;
      bottom: 0;
    ">
    <div class="IN" style="
        font-size: 0.8rem;
        line-height: 1rem;
        width: 0;
        height: 1rem;
        background-color: #ddd;
        text-align: right;
        color: #222;
      "></div>
  </div>

  <div class="Book__Side Book__Chapter_Menu lang-{{page.lang}}">
    <script>
      let h2h3_highlighted = () => { }

      {
        const bookContent = document.querySelector("#Book__Content")
        const h2h3 = bookContent.querySelectorAll("h2, h3, h4")

        document.writeln("<h4>{% if page.lang == 'en' %}Sections{% else %}目錄{% endif %}</h4>")
        document.writeln("<ul id='Book__Chapter_Menu__List'>")
        h2h3.forEach((el, n) => {
          const text = el.textContent
          const id = el.id || text.replace(/\s+/g, "-").toLowerCase()
          document.writeln(
            `<li class="${el.tagName}"><a data-index="${n}" href="#${id}">${text}</a></li>`,
          )
        })
        document.writeln("</ul>")

        document.addEventListener("DOMContentLoaded", () => {
          const Book__Chapter_Menu__List = document.querySelector(
            "#Book__Chapter_Menu__List",
          )

          Book__Chapter_Menu__List.addEventListener("click", (evt) => {
            if (evt.target.tagName === "A") {
              const n = +evt.target.getAttribute("data-index")
              h2h3_highlighted(n)
            }

            requestAnimationFrame(updateReadProgress)
          })

          const listitems = Book__Chapter_Menu__List.querySelectorAll(
            "#Book__Chapter_Menu__List li",
          )

          h2h3_highlighted = (n) => {
            listitems.forEach((li, i) => {
              if (i === n) {
                li.classList.add("highlighted")
              } else {
                li.classList.remove("highlighted")
              }
            })
          }
        })

        const PageWrapper = document.querySelector(".page-wrapper")
        const BookReadProgressBar = document.querySelector(
          ".Book_Read_Progress .IN",
        )

        function updateReadProgress() {
          const progress =
            PageWrapper.scrollTop /
            (PageWrapper.scrollHeight - window.innerHeight)
          BookReadProgressBar.style.width = `${progress * 100}%`
          // BookReadProgressBar.textContent = `${Math.round(progress * 100)}%`
        }

        PageWrapper.addEventListener(
          "wheel", // wheel
          updateReadProgress,
          {
            passive: true,
          },
        )
      }
    </script>
  </div>
</div>

<script>
  {
    class HeadingTracker extends EventTarget {
      #bookContent = document.querySelector("#Book__Content")

      constructor() {
        super()
        this.headings = Array.from(this.#bookContent.querySelectorAll("h2, h3, h4"))
        this.visibleHeadings = new Set()
        this.currentHeading = null
        this._initObserver()
      }

      _initObserver() {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              const heading = entry.target
              if (entry.isIntersecting) {
                this.visibleHeadings.add(heading)
              } else {
                this.visibleHeadings.delete(heading)
              }
            })

            const sorted = Array.from(this.visibleHeadings).sort(
              (a, b) =>
                a.getBoundingClientRect().top - b.getBoundingClientRect().top,
            )

            const topHeading = sorted[0]
            if (topHeading && topHeading !== this.currentHeading) {
              this.currentHeading = topHeading
              this.dispatchEvent(
                new CustomEvent("headingchange", {
                  detail: {
                    index: this.headings.indexOf(topHeading),
                    element: topHeading,
                    tag: topHeading.tagName.toLowerCase(),
                    text: topHeading.textContent.trim(),
                  },
                }),
              )
            }
          },
          {
            rootMargin: "-20% 0px -60% 0px", // 控制觸發範圍
            threshold: 0.1,
          },
        )

        this.headings.forEach((h) => observer.observe(h))
      }
    }

    const tracker = new HeadingTracker()

    tracker.addEventListener("headingchange", (e) => {
      const { tag, text, index } = e.detail
      h2h3_highlighted(index)
    })
  }

  function PlayAnimationExplain({ name }) {
    createAndShowFullScreenDialog(`/play/webgl/${name}?t=${Date.now()}`)
  }

  function IhateThisKiddyFont() {
    const BookContent = document.querySelector('#Book__Content');
    BookContent.classList.add('kiddy-font-disabled');
    document.querySelector('.IhateThisKiddyFont').style.display = 'none';
  }

  var __isFullscreen__ = false;
  var __isFKeyUpOrBtnClicked__ = false;
  function __set_isFullscreen__(val, esc) {
    if (__isFullscreen__ === val) return;

    __isFullscreen__ = val;

    if (__isFullscreen__) {
      doOpenFullscreen();
      const target = document.querySelector('#FullscreenToggle').firstElementChild
      target.style.display = 'none';
      target.nextElementSibling.style.display = '';
    } else {
      if (esc === undefined || esc === false) {
        doCloseFullscreen();
      }
      const target = document.querySelector('#FullscreenToggle').lastElementChild
      target.style.display = 'none';
      target.previousElementSibling.style.display = '';
    }
  }

  function doOpenFullscreen() {
    const elem = document.documentElement; // 預設全屏整個頁面
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) { // Safari
      elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { // IE11
      elem.msRequestFullscreen();
    }
  }

  function doCloseFullscreen() {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) { // Safari
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { // IE11
      document.msExitFullscreen();
    }
  }

  function openFullscreen(evt) {
    __isFKeyUpOrBtnClicked__ = true;
    __set_isFullscreen__(true);
  }

  function closeFullscreen(evt) {
    __isFKeyUpOrBtnClicked__ = true;
    __set_isFullscreen__(false);
  }

  document.onfullscreenchange = () => {
    if (__isFKeyUpOrBtnClicked__) {
    } else {
      __set_isFullscreen__(false, true);
    }

    __isFKeyUpOrBtnClicked__ = false;
  }

  window.addEventListener('keyup', (evt) => {
    if (evt.key === 'f') {
      __isFKeyUpOrBtnClicked__ = true;
      __set_isFullscreen__(!__isFullscreen__);
    }
  })
</script>

{% if page.math %}
<script>
  // Function to create and show the full-screen dialog
  function createAndShowFullScreenDialog(iframeUrl) {
    // 1. Create the <dialog> element
    const fullScreenDialog = document.createElement('dialog');
    fullScreenDialog.id = 'fullScreenDialog';

    // 2. Create a content wrapper for positioning the close button and iframe
    const contentWrapper = document.createElement('div');
    contentWrapper.classList.add('dialog-content-wrapper');

    // 3. Create the close button
    const closeButton = document.createElement('button');
    closeButton.classList.add('close-button');
    closeButton.innerHTML = '&times;'; // HTML entity for 'x'

    // 4. Create the iframe
    const iframeElement = document.createElement('iframe');
    iframeElement.id = 'fullScreenIframe';
    iframeElement.src = iframeUrl;
    iframeElement.setAttribute('frameborder', '0'); // Good practice for iframes

    // 5. Append elements to their parents
    contentWrapper.appendChild(closeButton);
    contentWrapper.appendChild(iframeElement);
    fullScreenDialog.appendChild(contentWrapper);

    // 6. Append the dialog to the body
    document.body.appendChild(fullScreenDialog);

    // 7. Add event listeners
    closeButton.addEventListener('click', () => {
      fullScreenDialog.close();
    });

    // Event listener for when the dialog is closed (e.g., by Escape key or dialog.close())
    fullScreenDialog.addEventListener('close', () => {
      iframeElement.src = 'about:blank'; // Clear iframe src

      setTimeout(() => {
        document.body.removeChild(fullScreenDialog); // Remove dialog from DOM
      }, 50);
    });

    // 8. Show the dialog
    fullScreenDialog.showModal();
  }

  document.addEventListener("DOMContentLoaded", function () {
    const container = document.querySelector('#Book__Content');

    if (!container) {
      console.warn("No container found for rendering math.");
      return;
    }

    renderMathInElement(container, {
      delimiters: [
        { left: "$$", right: "$$", display: true },  // Block math
        { left: "\\begin{equation}", right: "\\end{equation}", display: true },  // Block math
        { left: "\\[", right: "\\]", display: true },  // Block math
        { left: "$", right: "$", display: false },   // Inline math
        { left: "\\(", right: "\\)", display: false }    // Inline math
      ],
      throwOnError: false
    });

    container.querySelectorAll("pre code.language-math").forEach((block) => {
      const tex = block.textContent.trim();
      const wrapper = document.createElement("div");
      katex.render(tex, wrapper, { displayMode: true, throwOnError: false });
      block.replaceWith(wrapper);
    });
  });
</script>
{% endif %}