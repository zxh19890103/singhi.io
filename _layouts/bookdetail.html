---
layout: with-nonav
---

<div class="Book">
  <div class="Book__Title">
    第{{page.chapter}}章：{{page.title}}
  </div>
  <div>
    <div class="Book__Meta">
      <a href="javascript:void();" style="width: 24px; height: 24px;" title="Go back to the list page."
        onclick="__goBackToIndex();">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-left-dashed">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M5 12h6m3 0h1.5m3 0h.5" />
          <path d="M5 12l6 6" />
          <path d="M5 12l6 -6" />
        </svg>
      </a>

      {% if page.src %}
      <a href="{{page.src}}" style="width: 24px; height: 24px;" title="Go to the source/related article."
        target="_blank" rel="noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-world">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" />
          <path d="M3.6 9h16.8" />
          <path d="M3.6 15h16.8" />
          <path d="M11.5 3a17 17 0 0 0 0 18" />
          <path d="M12.5 3a17 17 0 0 1 0 18" />
        </svg>
      </a>
      {% endif %}

      <a title="X(twitter) share" style="width: 24px; height: 24px;" rel="noopener noreferrer"
        href="https://x.com/intent/tweet?url=https%3A//www.zhangxinghai.cn{{ page.url }}" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-brand-x">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path d="M4 4l11.733 16h4.267l-11.733 -16z" />
          <path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772" />
        </svg>
      </a>

      <a title="Wechat(VX for short, a stupid/terrible IM platform designed and controlled by China.) touch."
        style="width: 24px; height: 24px;" rel="noopener noreferrer" href="javascript:void(0);"
        onclick="showPhotoModal('https://zxh1989.oss-cn-qingdao.aliyuncs.com/20181105/151627_71615.jpg'); return false;"
        target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-brand-wechat">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <path
            d="M16.5 10c3.038 0 5.5 2.015 5.5 4.5c0 1.397 -.778 2.645 -2 3.47l0 2.03l-1.964 -1.178a6.649 6.649 0 0 1 -1.536 .178c-3.038 0 -5.5 -2.015 -5.5 -4.5s2.462 -4.5 5.5 -4.5z" />
          <path
            d="M11.197 15.698c-.69 .196 -1.43 .302 -2.197 .302a8.008 8.008 0 0 1 -2.612 -.432l-2.388 1.432v-2.801c-1.237 -1.082 -2 -2.564 -2 -4.199c0 -3.314 3.134 -6 7 -6c3.782 0 6.863 2.57 7 5.785l0 .233" />
          <path d="M10 8h.01" />
          <path d="M7 8h.01" />
          <path d="M15 14h.01" />
          <path d="M18 14h.01" />
        </svg></a>

      {% if page.editing %}
      <span style="color: rgb(143, 95, 7)">狀態：<em>...</em></span>
      {% endif %}

      <span>發布時間：{{page.date | date: "%Y-%m-%d"}}</span>

      {% assign words = page.content | number_of_words: "auto" %}
      {% assign minutes_float = words | divided_by:200.0 %}
      {% assign minutes = minutes_float | ceil %}

      <span>閱讀時間：{{ minutes }} 分鐘</span>
    </div>
  </div>
  <div id="Book__Content" class="Book__Content">{{content}}</div>
  <div class="Book__End" style="height: 1px; background: #ddd; width: 61.8%; margin: 3rem auto"></div>
  <div class="Book__Page" style="display: flex; justify-content: space-between; margin-bottom: 3rem">
    {% if page.previous %}
    <a href="{{page.previous.url}}">上一章：{{page.previous.title}}</a>
    {% else %}
    <a href="javascript:void(0);" style="color: #777; pointer-events: none">开始</a>
    {% endif %}

    {% if page.next %}
    <a href="{{page.next.url}}">下一章：{{page.next.title}}</a>
    {% else %}
    <a href="javascript:void(0);" style="color: #777; pointer-events: none">结束</a>
    {% endif %}
  </div>
  <div class="Book__Side Book__Chapters">
    <h2>章節</h2>
    <ul>
      {% for chapter in site[page.book] %}
      <li>
        <a href="{{chapter.url}}"
          class="{% if page.path == chapter.path %}disabled{% else %}normal{% endif %}">{{chapter.chapter}}：{{chapter.title}}</a>
      </li>
      {% endfor %}
    </ul>
  </div>
  <div class="Book_Read_Progress" style="
      z-index: 40;
      position: fixed;
      width: 100vw;
      height: fit-content;
      left: 0;
      bottom: 0;
      background-color: rgb(30, 40, 49);
    ">
    <div class="IN" style="
        font-size: 0.8rem;
        line-height: 1rem;
        width: 0;
        height: 1rem;
        background-color: #ddd;
        text-align: right;
        color: #222;
      "></div>
  </div>
  <div class="Book__Side Book__Chapter_Menu">
    <script>
      let h2h3_highlighted = () => { }

      {
        const bookContent = document.querySelector("#Book__Content")
        const h2h3 = bookContent.querySelectorAll("h2, h3")

        document.writeln("<h2>目錄</h2>")
        document.writeln("<ul id='Book__Chapter_Menu__List'>")
        h2h3.forEach((el, n) => {
          const text = el.textContent
          const id = el.id || text.replace(/\s+/g, "-").toLowerCase()
          document.writeln(
            `<li class="${el.tagName}"><a data-index="${n}" href="#${id}">${text}</a></li>`,
          )
        })
        document.writeln("</ul>")

        document.addEventListener("DOMContentLoaded", () => {
          const Book__Chapter_Menu__List = document.querySelector(
            "#Book__Chapter_Menu__List",
          )

          Book__Chapter_Menu__List.addEventListener("click", (evt) => {
            if (evt.target.tagName === "A") {
              const n = +evt.target.getAttribute("data-index")
              h2h3_highlighted(n)
            }

            requestAnimationFrame(updateReadProgress)
          })

          const listitems = Book__Chapter_Menu__List.querySelectorAll(
            "#Book__Chapter_Menu__List li",
          )

          h2h3_highlighted = (n) => {
            listitems.forEach((li, i) => {
              if (i === n) {
                li.classList.add("highlighted")
              } else {
                li.classList.remove("highlighted")
              }
            })
          }
        })

        const PageWrapper = document.querySelector(".page-wrapper")
        const BookReadProgressBar = document.querySelector(
          ".Book_Read_Progress .IN",
        )

        function updateReadProgress() {
          const progress =
            PageWrapper.scrollTop /
            (PageWrapper.scrollHeight - window.innerHeight)
          BookReadProgressBar.style.width = `${progress * 100}%`
          BookReadProgressBar.textContent = `${Math.round(progress * 100)}%`
        }

        PageWrapper.addEventListener(
          "wheel", // wheel
          updateReadProgress,
          {
            passive: true,
          },
        )
      }
    </script>
  </div>
</div>
<script>
  {
    class HeadingTracker extends EventTarget {
      #bookContent = document.querySelector("#Book__Content")

      constructor() {
        super()
        this.headings = Array.from(this.#bookContent.querySelectorAll("h2, h3"))
        this.visibleHeadings = new Set()
        this.currentHeading = null
        this._initObserver()
      }

      _initObserver() {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              const heading = entry.target
              if (entry.isIntersecting) {
                this.visibleHeadings.add(heading)
              } else {
                this.visibleHeadings.delete(heading)
              }
            })

            const sorted = Array.from(this.visibleHeadings).sort(
              (a, b) =>
                a.getBoundingClientRect().top - b.getBoundingClientRect().top,
            )

            const topHeading = sorted[0]
            if (topHeading && topHeading !== this.currentHeading) {
              this.currentHeading = topHeading
              this.dispatchEvent(
                new CustomEvent("headingchange", {
                  detail: {
                    index: this.headings.indexOf(topHeading),
                    element: topHeading,
                    tag: topHeading.tagName.toLowerCase(),
                    text: topHeading.textContent.trim(),
                  },
                }),
              )
            }
          },
          {
            rootMargin: "-20% 0px -60% 0px", // 控制觸發範圍
            threshold: 0.1,
          },
        )

        this.headings.forEach((h) => observer.observe(h))
      }
    }

    const tracker = new HeadingTracker()

    tracker.addEventListener("headingchange", (e) => {
      const { tag, text, index } = e.detail
      h2h3_highlighted(index)
    })
  }
</script>