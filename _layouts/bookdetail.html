---
layout: with-nonav
---

<div class="Book">
  <div
    class="Book__Title"
    style="font-size: 2rem; text-align: center; margin: 4rem 0"
  >
    ç¬¬{{page.chapter}}ç« ï¼š{{page.title}}
  </div>
  <div>
    <div
      class="Book__Meta"
      style="
        display: flex;
        gap: 1.5rem;
        row-gap: normal;
        flex-wrap: wrap;
        justify-content: flex-start;
        margin-bottom: 2rem;
      "
    >
      <a
        href="javascript:void();"
        style="color: #333"
        title="Go back to the list page."
        onclick="__goBackToIndex();"
      >
        &larr;
      </a>

      {% if page.src %}
      <a
        href="{{page.src}}"
        title="Go to the source/related article."
        target="_blank"
        rel="noopener noreferrer"
      >
        ğ•Š
      </a>
      {% endif %}

      <a
        title="X(twitter) share"
        rel="noopener noreferrer"
        href="https://x.com/intent/tweet?url=https%3A//www.zhangxinghai.cn{{ page.url }}"
        target="_blank"
        >ğ•</a
      >

      <a
        title="Wechat(VX for short, a stupid/terrible IM platform designed and controlled by China.) touch."
        rel="noopener noreferrer"
        href="javascript:void(0);"
        onclick="showPhotoModal('https://zxh1989.oss-cn-qingdao.aliyuncs.com/20181105/151627_71615.jpg'); return false;"
        target="_blank"
        >ğ•</a
      >

      {% if page.editing %}
        <span style="color: rgb(143, 95, 7)">ç‹€æ…‹ï¼šç·¨è¼¯ä¸­</span>
      {% endif %}

      <span>ç™¼å¸ƒæ™‚é–“ï¼š{{page.date | date: "%Y-%m-%d"}}</span>

      {% assign words = page.content | number_of_words: "auto" %}
      {% assign minutes_float = words | divided_by:200.0 %}
      {% assign minutes = minutes_float | ceil %}

      <span>é–±è®€æ™‚é–“ï¼š{{ minutes }} åˆ†é˜</span>
    </div>
  </div>
  <div id="Book__Content" class="Book__Content">{{content}}</div>
  <div
    class="Book__End"
    style="height: 1px; background: #ddd; width: 61.8%; margin: 3rem auto"
  ></div>
  <div
    class="Book__Page"
    style="display: flex; justify-content: space-between; margin-bottom: 3rem"
  >
    {% if page.previous %}
    <a href="{{page.previous.url}}">ä¸Šä¸€ç« ï¼š{{page.previous.title}}</a>
    {% else %}
    <a href="javascript:void(0);" style="color: #777; pointer-events: none">å¼€å§‹</a>
    {% endif %}
    
    {% if page.next %}
    <a href="{{page.next.url}}">ä¸‹ä¸€ç« ï¼š{{page.next.title}}</a>
    {% else %}
    <a href="javascript:void(0);" style="color: #777; pointer-events: none">ç»“æŸ</a>
    {% endif %}
  </div>
  <div class="Book__Side Book__Chapters">
    <h2>ç« ç¯€</h2>
    <ul>
      {% for chapter in site[page.book] %}
      <li>
        <a
          href="{{chapter.url}}"
          class="{% if page.path == chapter.path %}disabled{% else %}normal{% endif %}"
          >{{chapter.chapter}}ï¼š{{chapter.title}}</a
        >
      </li>
      {% endfor %}
    </ul>
  </div>
  <div
    class="Book_Read_Progress"
    style="
      z-index: 40;
      position: fixed;
      width: 100vw;
      height: fit-content;
      left: 0;
      bottom: 0;
      background-color: rgb(30, 40, 49);
    "
  >
    <div
      class="IN"
      style="
        font-size: 0.8rem;
        line-height: 1rem;
        width: 0;
        height: 1rem;
        background-color: #ddd;
        text-align: right;
        color: #222;
      "
    ></div>
  </div>
  <div class="Book__Side Book__Chapter_Menu">
    <script>
      let h2h3_highlighted = () => {}

      {
        const bookContent = document.querySelector("#Book__Content")
        const h2h3 = bookContent.querySelectorAll("h2, h3")

        document.writeln("<h2>ç›®éŒ„</h2>")
        document.writeln("<ul id='Book__Chapter_Menu__List'>")
        h2h3.forEach((el, n) => {
          const text = el.textContent
          const id = el.id || text.replace(/\s+/g, "-").toLowerCase()
          document.writeln(
            `<li class="${el.tagName}"><a data-index="${n}" href="#${id}">${text}</a></li>`,
          )
        })
        document.writeln("</ul>")

        document.addEventListener("DOMContentLoaded", () => {
          const Book__Chapter_Menu__List = document.querySelector(
            "#Book__Chapter_Menu__List",
          )

          Book__Chapter_Menu__List.addEventListener("click", (evt) => {
            if (evt.target.tagName === "A") {
              const n = +evt.target.getAttribute("data-index")
              h2h3_highlighted(n)
            }

            requestAnimationFrame(updateReadProgress)
          })

          const listitems = Book__Chapter_Menu__List.querySelectorAll(
            "#Book__Chapter_Menu__List li",
          )

          h2h3_highlighted = (n) => {
            listitems.forEach((li, i) => {
              if (i === n) {
                li.classList.add("highlighted")
              } else {
                li.classList.remove("highlighted")
              }
            })
          }
        })

        const PageWrapper = document.querySelector(".page-wrapper")
        const BookReadProgressBar = document.querySelector(
          ".Book_Read_Progress .IN",
        )

        function updateReadProgress() {
          const progress =
            PageWrapper.scrollTop /
            (PageWrapper.scrollHeight - window.innerHeight)
          BookReadProgressBar.style.width = `${progress * 100}%`
          BookReadProgressBar.textContent = `${Math.round(progress * 100)}%`
        }

        PageWrapper.addEventListener(
          "wheel", // wheel
          updateReadProgress,
          {
            passive: true,
          },
        )
      }
    </script>
  </div>
</div>
<script>
  {
    class HeadingTracker extends EventTarget {
      #bookContent = document.querySelector("#Book__Content")

      constructor() {
        super()
        this.headings = Array.from(this.#bookContent.querySelectorAll("h2, h3"))
        this.visibleHeadings = new Set()
        this.currentHeading = null
        this._initObserver()
      }

      _initObserver() {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              const heading = entry.target
              if (entry.isIntersecting) {
                this.visibleHeadings.add(heading)
              } else {
                this.visibleHeadings.delete(heading)
              }
            })

            const sorted = Array.from(this.visibleHeadings).sort(
              (a, b) =>
                a.getBoundingClientRect().top - b.getBoundingClientRect().top,
            )

            const topHeading = sorted[0]
            if (topHeading && topHeading !== this.currentHeading) {
              this.currentHeading = topHeading
              this.dispatchEvent(
                new CustomEvent("headingchange", {
                  detail: {
                    index: this.headings.indexOf(topHeading),
                    element: topHeading,
                    tag: topHeading.tagName.toLowerCase(),
                    text: topHeading.textContent.trim(),
                  },
                }),
              )
            }
          },
          {
            rootMargin: "-20% 0px -60% 0px", // æ§åˆ¶è§¸ç™¼ç¯„åœ
            threshold: 0.1,
          },
        )

        this.headings.forEach((h) => observer.observe(h))
      }
    }

    const tracker = new HeadingTracker()

    tracker.addEventListener("headingchange", (e) => {
      const { tag, text, index } = e.detail
      h2h3_highlighted(index)
    })
  }
</script>
